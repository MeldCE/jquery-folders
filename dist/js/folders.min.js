jQuery&&function(e){e.extend(e.fn,{folders:function(){function i(e,i){var t,s,l,n,a,o,d=0,r=/(\.\d+)|(\d+(\.\d+)?)|([^\d.]+)|(\.\D+)|(\.$)/g;if(e===i)return 0;for(t=e.toLowerCase().match(r),s=i.toLowerCase().match(r),o=t.length;o>d;){if(!s[d])return 1;if(l=t[d],n=s[d++],l!==n)return a=l-n,isNaN(a)?l>n?1:-1:a}return s[d]?-1:0}function t(e,i){i.error||s(e.children("div"),i)}function s(i,t,s){var n,a,o=!1;i.children("div").has("ul").length?(o=!0,a=i.children("div").children("ul")):i.children("div").html(a=e("<ul></ul>"));for(n in t)l.apply(this,[a,t[n],s])}function l(t,s,l,d){var h,c,p=e('<li data-id="'+s.id+'"></li>');if(d){var f;t.children().each(function(){return i(e(this).text(),s.label)>0?!1:void(f=e(this))}),f?(console.log("after"),console.log(f),f.after(p)):(console.log("no after"),t.prepend(p))}else t.append(p);p.append(h=e("<label>"+s.label+"</label>")),this.options.name,p.click(a.bind(this,p,s)),s._obj=p,this.options.create&&(p.append(c=e('<a title="Create a new sub-folder">+</a>')),c.click(o.bind(this,p,s.id)),p.append(c=e('<a title="Delete folder">-</a>')),c.click(r.bind(this,p,s.id,s.label))),s.sub&&n.apply(this,[p,s.sub,l])}function n(i,t,l){var n,a;i.addClass("parent"),i.append(n=e('<span title="Expand Folder">&raquo;</span>')),i.append(a=e("<div></div>")),n.click(c.bind(this,i)),t!==!0&&s.apply(this,[i,t,l+this.options.separator+name])}function a(i,t,s){if(!s.isDefaultPrevented()){s.preventDefault();var l=!1;if(this.selection[t.id]){delete this.selection[t.id],i.removeClass(this.options.selectedClass);var n=this;i.parents().each(function(){return e(this).is(n.div)?!1:e(this).find("."+n.options.selectedClass).length?!1:void e(this).removeClass("childSelected")})}else{if(l=!0,i.addClass(this.options.selectedClass),this.options.multiple){var n=this;i.parents().each(function(){return e(this).is(n.div)?!1:void(e(this).is("li")&&e(this).addClass("childSelected"))})}else{if(this.selection){var a;for(a in this.selection)this.options.selectedClass&&this.selection[a]._obj&&this.selection[a]._obj.removeClass(this.options.selectedClass),delete this.selection[a]}c.apply(this,[this.div,null,!1])}this.selection[t.id]=t}this.options.name;var a,o=0;for(a in this.selection)o++;switch(o){case 0:this.mainLabel.text(this.options.selectLabel);break;case 1:this.mainLabel.text(this.selection[a].label+(this.options.multiple?" selected":""));break;default:this.mainLabel.text(o+" folders selected")}if(this.options.selection){var a,l=[];for(a in this.selection)l.push(this.selection[a]);this.options.selection(l)}}}function o(i,t,s){if(!s.isDefaultPrevented()){s.preventDefault();var l;if(l=prompt("Please enter a name for the new folder")){var n={a:"create",name:l};t&&(n.id=t),e.post(this.options.ajaxScript,n,d.bind(this,i,l))}}}function d(e,i,t){return t.error?void alert(t.error):(e.hasClass("parent")||n.apply(this,[e,!0]),l.apply(this,[e.children("div").children("ul"),{label:i,id:t.id},null,!0]),void c.apply(this,[e,null,!0]))}function r(i,t,s,l){if(!l.isDefaultPrevented()){l.preventDefault();var n;if(n=confirm("Are you sure you want to delete the "+s+" folder? All files and folders within this folder will be deleted.")){var a={a:"delete",id:t};e.post(this.options.ajaxScript,a,h.bind(this,i))}}}function h(e,i){return i.error?void alert(i.error):(i.msg&&alert(i.msg),void e.remove())}function c(i,l,n,a){if(l){if(l.isDefaultPrevented())return;l.preventDefault()}if(i.hasClass("expand")&&n!==!0)i.removeClass("expand"),i.children("span").html("&raquo;");else if(n!==!1&&(i.children("span").html("&laquo;"),this.options.collapseSiblings&&(i.siblings("li").removeClass("expand"),i.siblings("li").children("span").html("&raquo;")),i.addClass("expand"),!i.children("div").has("ul").length||a)){if(a)s(i,a);else{if(!this.options.ajaxScript)return;i.children("div").html(this.options.loadingLabel),e.post(this.options.ajaxScript,{id:i.attr("data-id")},t.bind(this,i))}}}function p(i){e(i.target).parents().is(this.obj)||c.apply(this,[this.div,null,!1])}function f(i,t){this.options=e.extend({loadingLabel:"Loading...",selectLabel:"Select a folder",multiple:!1,create:!1,separator:"/",collapseSiblings:!0,"class":"jFolders"},t),this.options.selectedClass||(this.options.selectedClass="selected"),this.obj=i,this.selection={},this.options.class&&i.addClass(this.options.class),i.append(this.div=e("<div></div>")),this.div.html(this.mainLabel=e("<label>"+this.options.selectLabel+"</label>")),this.options.create&&this.obj.append(createLink=e("<a>New</a>").click(o.bind(this,this.div,null))),this.div.append(e("<div></div>")),this.div.click(c.bind(this,this.div)),this.options.files&&s.apply(this,[this.div,this.options.files]),e(document).on("click",p.bind(this))}return function(i,t){e(this).each(function(){new f(e(this),i,t)})}}()})}(jQuery);